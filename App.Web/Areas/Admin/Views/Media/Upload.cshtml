@{
    ViewBag.Title = "Media to Upload and Save in the DB";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutPage.cshtml";
}

<div class="row">    
    <section class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
        <div class="panel panel-default">
            <div class="panel-heading">
                Upload New Files
            </div>
            <div class="panel-body row">
                <label for="fileselect">Files to upload:</label>
                <input type="file" id="filesToUpload" name="filesToUpload[]" multiple="multiple" />
                <div id="filedrag">or drop files here</div>         
            </div>     
        </div>   
    </section>
    <section class="col-xs-12 col-sm-12 col-md-8 col-lg-8">
        <div class="panel panel-default">
            <div class="panel-heading">
                List of media to upload &amp; create
            </div>
            <div id="medium-upload-list" class="panel-body row">
            </div>
        </div>        
    </section>
</div>
<div id="delete-medium-dialog" title="Delete medium">
    <p>Are you sure you want to delete this medium?</p>
</div>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script>
        var currentFileIndex = 0;
        (function () {
            document.getElementById('filesToUpload').addEventListener('change', uploadSelectedFiles, false);
        })();
        function uploadSelectedFiles(event) {
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                var files = event.target.files;
                if (files != null && files.length > 0) {
                    var file, fileUIId;
                    for (var i = 0; i < files.length; i++) {
                        file = files[i];
                        fileUIId = "f" + currentFileIndex;
                        createFileUI(file, fileUIId);
                        uploadFile(file, fileUIId);//Upload file to the server
                        currentFileIndex++;
                    }
                } else {
                    console.log("No Files selected!");
                }
            }
            else {
                console.log("File API not supported!");
            }
        }
        function createFileUI(file, fileUIId) {
            $('#medium-upload-list').prepend(
                '<article id="' + fileUIId + '" class="medium col-xs-12 col-sm-12 col-md-6 col-lg-4">'
                + escape(file.name)
                + (file.type || 'n/a')
                + file.size / 1024 + ' kb'
                + 'last modified: ' + (file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() : 'n/a')
                + '<div class="progress progress-striped active">'
                + '<div class="progress-bar"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 45%">'
                + '<span class="sr-only">45% Complete</span>'
                + '</div>'
                + '</div>'
                + '</article>');
        }
        function uploadFile(file, fileUIId) {
            var xhr = new XMLHttpRequest();
            var formData = new FormData();
            formData.append('fileUIId', fileUIId);
            formData.append('file', file);
            xhr.upload.addEventListener("progress", function (e) {
                if (e.lengthComputable) {
                    var percentage = Math.round((e.loaded * 100) / e.total);
                    $('#' + fileUIId + ' .progress-bar').attr("aria-valuenow", percentage);
                    $('#' + fileUIId + ' .progress-bar').attr("style", "width:" + percentage + "%");
                    $('#' + fileUIId + ' .sr-only').html(percentage + "% Complete"); 
                }
            }, false);
            xhr.upload.addEventListener("loadstart", function (e) {
            }, false);
            xhr.upload.addEventListener("load", function (e) {
                $('#' + fileUIId + ' .progress-bar').attr("aria-valuenow", 100);
                $('#' + fileUIId + ' .progress-bar').attr("style", "width:" + 100 + "%");
                $('#' + fileUIId + ' .sr-only').html(100 + "% Done");
            }, false);
            xhr.addEventListener("readystatechange", function (e) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    $('#' + fileUIId).html(xhr.responseText);
                }
            }, false);
            xhr.open("POST", "UploadFile/");
            xhr.send(formData);
        }
    </script>
}